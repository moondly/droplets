---
- hosts: dockerRegistry*
  become: yes
  become_method: sudo

  vars_files:
    - vars.yml

  pre_tasks:  
    - name: Disable IPv6
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        reload: yes
      loop:
        - { name: net.ipv6.conf.all.disable_ipv6, value: 1 }
        - { name: net.ipv6.conf.default.disable_ipv6, value: 0 } 
        - { name: net.ipv6.conf.lo.disable_ipv6, value: 1 }

  roles:
    - geerlingguy.docker
  
  tasks:
    - name: Install required packages
      apt:
        pkg:
          - python3-pip

    - name: Install docker pip module
      pip:
        name: docker
    
    - name: Create mount point
      file:
        path: /mnt/registry
        owner: root
        group: root
        mode: 0744
        state: directory
        
    - name: Create registry container
      docker_container:
        name: registry
        image: registry:2
        state: started
        restart: yes
        restart_policy: always
        recreate: yes
        published_ports:
          - "5000:5000"
        volumes:
          - /mnt/registry:/var/lib/registry

    - name: Readme
      local_action: template
      args:
        src: "readme.j2"
        dest: "{{ drop_home }}/README"
        mode: '0644'
      run_once: true

