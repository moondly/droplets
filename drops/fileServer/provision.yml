---
- hosts: fileServer*
  become: yes
  become_method: sudo

  vars_files:
    - vars.yml
  
  pre_tasks:  
    - name: Disable IPv6
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        reload: yes
      loop:
        - { name: net.ipv6.conf.all.disable_ipv6, value: 1 }
        - { name: net.ipv6.conf.default.disable_ipv6, value: 0 } 
        - { name: net.ipv6.conf.lo.disable_ipv6, value: 1 }
        
  tasks:
    - name: Create mount point
      file:
        path: /var/files
        owner: root
        group: root
        mode: 0744
        state: directory

    - name: Config systemd service
      blockinfile:
        path: /lib/systemd/system/fileserver.service
        create: yes
        block: |
            [Unit]
            Description=Fileserver Service
            After=multi-user.target

            [Service]
            Type=simple
            WorkingDirectory=/var/files
            ExecStart=/usr/bin/python3 -m http.server 8000

            [Install]
            WantedBy=multi-user.target

    - name: Start service
      service:
        name: fileserver.service
        state: started
        enabled: yes

    - name: Readme
      local_action: template
      args:
        src: "readme.j2"
        dest: "{{ drop_home }}/README"
        mode: '0644'
      run_once: true

